name: _job_build

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string

jobs:
  proton:
    name: Build ${{ inputs.name }}
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup disk space
        uses: endersonmenezes/free-disk-space@v3
        with:
          remove_android: true
          remove_dotnet: true
          remove_haskell: true
          remove_tool_cache: true
          remove_codeql: true
          remove_docker_images: true
          remove_swap: true
          remove_packages: |
            azure-cli google-cloud-cli google-chrome-stable firefox microsoft-edge-stable
            postgresql* mysql* php* temurin-* *llvm* clang* mono-devel powershell dotnet-sdk-*
          remove_folders: |
            /usr/share/swift /usr/share/miniconda /usr/local/lib/node_modules
            /usr/local/share/chromium /usr/local/share/powershell /usr/local/julia*
            /usr/local/aws-cli /usr/local/aws-sam-cli /usr/share/gradle /usr/share/az*
            /usr/local/.ghcup

      - name: Prepare host
        run: sudo apt update && sudo apt-get install -y ccache fontforge-nox

      - name: Restore cache
        id: ccache-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.ccache
          key: ccache-proton-${{ github.run_id }}
          restore-keys: |
            ccache-proton

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: false

      - name: Patch
        run: |
          git submodule update --init --filter=tree:0 --recursive
          # apply proton-ge-custom patches
          # ./patches/protonprep-valve-staging.sh || true
          cp ./signal_x86_64.c ./wine/dlls/ntdll/signal_x86_64.c
          # strip binaries at compile time to save space in the runner
          patch -Np1 -i ./.github/patches/0001-build-strip-binaries-early.patch
          mkdir ./build

      - name: Configure
        working-directory: ./build
        run: |
          ../configure.sh --build-name=${{ inputs.name }} --container-engine=docker

      - name: Make ${{ inputs.name }}
        working-directory: ./build
        run: |
          make -j$(nproc) redist

      - name: Save cache
        id: ccache-save
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ~/.ccache
          key: ${{ steps.ccache-restore.outputs.cache-primary-key }}

      - name: Upload artifact ${{ inputs.name }}.tar.gz
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.tar.gz
          path: ./build/${{ inputs.name }}.tar.gz

      - name: Upload artifact ${{ inputs.name }}.sha512sum
        uses: actions/upload-artifact@v5
        with:
          name: ${{ inputs.name }}.sha512sum
          path: ./build/${{ inputs.name }}.sha512sum

